-- 自然飞行脚本 - 保持角色动画
-- 不会让角色变得僵直

if not game:IsLoaded() then
    game.Loaded:Wait()
end

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
if not player then return end

-- 获取角色
local character = player.Character
if not character then
    character = player.CharacterAdded:Wait()
end

local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

-- 飞行状态
local flying = false
local currentSpeed = 50
local flightConnection
local originalGravity

-- 创建GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NaturalFlightGUI"
screenGui.Parent = player.PlayerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 220, 0, 150)
frame.Position = UDim2.new(0, 10, 0, 10)
frame.BackgroundColor3 = Color3.fromRGB(30, 40, 50)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = frame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 25)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundColor3 = Color3.fromRGB(20, 30, 40)
title.BorderSizePixel = 0
title.Text = "自然飞行系统"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 14
title.Parent = frame

local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -10, 0, 25)
statusLabel.Position = UDim2.new(0, 5, 0, 30)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "状态: 关闭"
statusLabel.TextColor3 = Color3.fromRGB(255, 80, 80)
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 12
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = frame

local speedLabel = Instance.new("TextLabel")
speedLabel.Size = UDim2.new(1, -10, 0, 25)
speedLabel.Position = UDim2.new(0, 5, 0, 55)
speedLabel.BackgroundTransparency = 1
speedLabel.Text = "速度: " .. currentSpeed
speedLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
speedLabel.Font = Enum.Font.Gotham
speedLabel.TextSize = 12
speedLabel.TextXAlignment = Enum.TextXAlignment.Left
speedLabel.Parent = frame

-- 速度控制
local speedDownBtn = Instance.new("TextButton")
speedDownBtn.Size = UDim2.new(0, 25, 0, 25)
speedDownBtn.Position = UDim2.new(0, 5, 0, 85)
speedDownBtn.BackgroundColor3 = Color3.fromRGB(60, 80, 100)
speedDownBtn.Text = "-"
speedDownBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
speedDownBtn.Font = Enum.Font.GothamBold
speedDownBtn.TextSize = 14
speedDownBtn.Parent = frame

local speedUpBtn = Instance.new("TextButton")
speedUpBtn.Size = UDim2.new(0, 25, 0, 25)
speedUpBtn.Position = UDim2.new(0, 35, 0, 85)
speedUpBtn.BackgroundColor3 = Color3.fromRGB(60, 80, 100)
speedUpBtn.Text = "+"
speedUpBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
speedUpBtn.Font = Enum.Font.GothamBold
speedUpBtn.TextSize = 14
speedUpBtn.Parent = frame

local speedValue = Instance.new("TextLabel")
speedValue.Size = UDim2.new(0, 60, 0, 25)
speedValue.Position = UDim2.new(0, 65, 0, 85)
speedValue.BackgroundTransparency = 1
speedValue.Text = currentSpeed
speedValue.TextColor3 = Color3.fromRGB(200, 220, 255)
speedValue.Font = Enum.Font.Gotham
speedValue.TextSize = 12
speedValue.Parent = frame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0, 100, 0, 30)
toggleBtn.Position = UDim2.new(0.5, -50, 1, -35)
toggleBtn.BackgroundColor3 = Color3.fromRGB(220, 80, 80)
toggleBtn.Text = "开始飞行"
toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 12
toggleBtn.Parent = frame

local btnCorner = Instance.new("UICorner")
btnCorner.CornerRadius = UDim.new(0, 6)
btnCorner.Parent = toggleBtn

-- 热键提示
local hotkeyLabel = Instance.new("TextLabel")
hotkeyLabel.Size = UDim2.new(1, -10, 0, 30)
hotkeyLabel.Position = UDim2.new(0, 5, 0, 115)
hotkeyLabel.BackgroundTransparency = 1
hotkeyLabel.Text = "F开关飞行  WASD移动  QE升降"
hotkeyLabel.TextColor3 = Color3.fromRGB(180, 200, 220)
hotkeyLabel.Font = Enum.Font.Gotham
hotkeyLabel.TextSize = 10
hotkeyLabel.TextXAlignment = Enum.TextXAlignment.Left
hotkeyLabel.Parent = frame

-- 自然飞行系统 - 使用更温和的方法
local function startNaturalFlight()
    if flying then return end
    
    flying = true
    statusLabel.Text = "状态: 飞行中"
    statusLabel.TextColor3 = Color3.fromRGB(80, 255, 80)
    toggleBtn.Text = "停止飞行"
    toggleBtn.BackgroundColor3 = Color3.fromRGB(80, 220, 80)
    
    -- 保存原始重力设置
    originalGravity = workspace.Gravity
    
    -- 轻微减少重力，让飞行更自然
    workspace.Gravity = originalGravity * 0.3
    
    -- 创建飞行物理对象（但更温和）
    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.Name = "FlightVelocity"
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.MaxForce = Vector3.new(10000, 10000, 10000) -- 更小的力量
    bodyVelocity.P = 800
    bodyVelocity.Parent = rootPart
    
    local bodyGyro = Instance.new("BodyGyro")
    bodyGyro.Name = "FlightGyro"
    bodyGyro.MaxTorque = Vector3.new(10000, 10000, 10000) -- 更小的扭矩
    bodyGyro.P = 800
    bodyGyro.D = 50
    bodyGyro.CFrame = rootPart.CFrame
    bodyGyro.Parent = rootPart
    
    -- 不设置PlatformStand，保持角色动画
    humanoid.PlatformStand = false
    
    -- 飞行主循环
    flightConnection = RunService.Heartbeat:Connect(function()
        if not flying or not character or not rootPart then return end
        
        -- 获取相机
        local camera = workspace.CurrentCamera
        
        -- 更新朝向（温和地跟随相机）
        if bodyGyro then
            local currentCF = bodyGyro.CFrame
            local targetCF = CFrame.new(rootPart.Position, rootPart.Position + camera.CFrame.LookVector)
            bodyGyro.CFrame = currentCF:Lerp(targetCF, 0.2) -- 平滑过渡
        end
        
        -- 计算移动方向
        local moveDirection = Vector3.new(0, 0, 0)
        
        -- 前后移动
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then
            local lookVector = camera.CFrame.LookVector
            moveDirection = moveDirection + Vector3.new(lookVector.X, 0, lookVector.Z)
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then
            local lookVector = camera.CFrame.LookVector
            moveDirection = moveDirection - Vector3.new(lookVector.X, 0, lookVector.Z)
        end
        
        -- 左右移动
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then
            moveDirection = moveDirection - camera.CFrame.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then
            moveDirection = moveDirection + camera.CFrame.RightVector
        end
        
        -- 上下移动
        if UserInputService:IsKeyDown(Enum.KeyCode.E) then
            moveDirection = moveDirection + Vector3.new(0, 1, 0)
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.Q) then
            moveDirection = moveDirection + Vector3.new(0, -1, 0)
        end
        
        -- 应用移动（更自然的移动）
        if bodyVelocity then
            if moveDirection.Magnitude > 0 then
                local moveVelocity = moveDirection.Unit * currentSpeed
                bodyVelocity.Velocity = Vector3.new(moveVelocity.X, moveVelocity.Y, moveVelocity.Z)
            else
                -- 轻微的下落，让飞行更自然
                bodyVelocity.Velocity = Vector3.new(0, -2, 0)
            end
        end
        
        -- 防止角色掉落
        if rootPart and rootPart.Position.Y < -500 then
            rootPart.CFrame = CFrame.new(0, 100, 0)
        end
    end)
    
    print("自然飞行已开启 - 角色动画保持正常")
end

local function stopNaturalFlight()
    if not flying then return end
    
    flying = false
    statusLabel.Text = "状态: 关闭"
    statusLabel.TextColor3 = Color3.fromRGB(255, 80, 80)
    toggleBtn.Text = "开始飞行"
    toggleBtn.BackgroundColor3 = Color3.fromRGB(220, 80, 80)
    
    -- 恢复重力
    if originalGravity then
        workspace.Gravity = originalGravity
    end
    
    -- 清理飞行对象
    local bodyVelocity = rootPart:FindFirstChild("FlightVelocity")
    if bodyVelocity then
        bodyVelocity:Destroy()
    end
    
    local bodyGyro = rootPart:FindFirstChild("FlightGyro")
    if bodyGyro then
        bodyGyro:Destroy()
    end
    
    -- 清理飞行连接
    if flightConnection then
        flightConnection:Disconnect()
        flightConnection = nil
    end
    
    print("飞行已关闭")
end

local function toggleNaturalFlight()
    if flying then
        stopNaturalFlight()
    else
        startNaturalFlight()
    end
end

-- 速度控制
local function changeSpeed(amount)
    currentSpeed = math.clamp(currentSpeed + amount, 10, 100)
    speedLabel.Text = "速度: " .. currentSpeed
    speedValue.Text = currentSpeed
end

-- 连接GUI事件
toggleBtn.MouseButton1Click:Connect(toggleNaturalFlight)
speedUpBtn.MouseButton1Click:Connect(function()
    changeSpeed(10)
end)
speedDownBtn.MouseButton1Click:Connect(function()
    changeSpeed(-10)
end)

-- 键盘控制
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.F then
        toggleNaturalFlight()
    elseif input.KeyCode == Enum.KeyCode.Equals then
        changeSpeed(10)
    elseif input.KeyCode == Enum.KeyCode.Minus then
        changeSpeed(-10)
    elseif input.KeyCode == Enum.KeyCode.R then
        -- 重置位置
        if character and rootPart then
            rootPart.CFrame = CFrame.new(0, 100, 0)
        end
    end
end)

-- 角色重生处理
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoid = character:WaitForChild("Humanoid")
    rootPart = character:WaitForChild("HumanoidRootPart")
    
    stopNaturalFlight()
end)

-- 脚本卸载清理
game:GetService("Players").PlayerRemoving:Connect(function(leavingPlayer)
    if leavingPlayer == player then
        stopNaturalFlight()
        if screenGui then
            screenGui:Destroy()
        end
    end
end)

print("====================================")
print("自然飞行脚本加载成功!")
print("按 F 键 - 开启/关闭飞行")
print("WASD - 前后左右移动")
print("Q/E - 下降/上升")
print("+/- - 调整飞行速度")
print("R - 重置位置")
print("====================================")